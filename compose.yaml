services:
  api :
    image : snipetz/api
    build :
      context : .
      dockerfile : api.dockerfile
      target : prod
    ports :
      - 80:80
    networks :
      - microservices_network
      - default
  # -------------- MICROSERVICES --------------------------
  auth:
    image : snipetz/auth
    build :
      context : .
      dockerfile : auth.dockerfile
      target : prod
    networks:
      - microservices_network
    links:
      - api:api
      - db:db
    environment:
      db_url : mongodb://auth_user:auth_user@db:27017/?authSource=auth
  # ----------------- DATABASES ------------------------
  db:
    image : mongodb/mongodb-community-server
    networks:
      - microservices_network
      - default
    volumes:
      - type: bind
        source: ./.volumes/mongodb
        target: /data/db
    environment:
      MONGODB_INITDB_ROOT_USERNAME : root
      MONGODB_INITDB_ROOT_PASSWORD : root
  db-express:
    image : mongo-express
    ports:
      - 8081:8081
    links:
      - db:mongo
    networks:
      - default
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: root
      ME_CONFIG_MONGODB_URL: mongodb://root:root@mongo:27017/
      ME_CONFIG_BASICAUTH: false


networks:
  microservices_network:
    external : false